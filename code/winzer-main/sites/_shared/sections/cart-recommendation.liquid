<link rel="stylesheet" href="{{ 'component-card.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-price.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-product-grid.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'section-product-recommendations.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'section-cart-recommendations.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'swiper-carousel-custom.css' | asset_url}}" media="print" onload="this.media='all'">


<noscript>{{ 'component-card.css' | asset_url | stylesheet_tag }}</noscript>
<noscript>{{ 'component-price.css' | asset_url | stylesheet_tag }}</noscript>
<noscript>{{ 'component-product-grid.css' | asset_url | stylesheet_tag }}</noscript>
<noscript>{{ 'section-cart-recommendations.css' | asset_url | stylesheet_tag }}</noscript>

{% capture margin_size %}
  {% if section.settings.display_margins %}
    {{ settings.margin_size }}
  {% else %}
    0
  {% endif %}
{% endcapture %}

{% capture mobile_margin_size %}
  {% if section.settings.display_margins %}
    {{ settings.mobile_margin_size }}
  {% else %}
    0
  {% endif %}
{% endcapture %}

{% style %}
  #shopify-section-{{ section.id }} {
    margin-top: {{ margin_size | divided_by: 10 }}rem;
    margin-bottom: {{ margin_size | divided_by: 10 }}rem;
  }

  @media screen and (max-width: 750px) {
    #shopify-section-{{ section.id }} {
      margin-top: {{ mobile_margin_size | divided_by: 10 }}rem;
      margin-bottom: {{ mobile_margin_size | divided_by: 10 }}rem;
    }
  }
{% endstyle %}

{% assign productId = "" %}
{% for item in cart.items %}
  {% if forloop.first == true %}
    {% assign productId = item.product_id %}
  {% endif %}
{% endfor %}


<div class="cart-recommendations {% if settings.scroll_appear == "fadein" %} fadeIn {% endif %}" style="background-color: {{ section.settings.background_color }};">
  <product-recommendations data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ productId }}">
    {% if recommendations.performed and recommendations.products_count > 0 %}
      <h2 class="cart-recommendations__heading {{ section.settings.heading_size }}">{{ section.settings.heading | escape }}</h2>
      <div class="cart-recommendation_slider" role="list">
        <ul class="swiper mySwiper" role="list">
          <div class="swiper-wrapper">
            {% for recommendation in recommendations.products %}
              <li class="swiper-slide">
                {% render 'product-card',
                  product_card_product: recommendation,
                  media_size: section.settings.image_ratio,
                  show_secondary_image: section.settings.show_secondary_image,
                  add_image_padding: section.settings.add_image_padding,
                  show_vendor: section.settings.show_vendor,
                  show_image_outline: section.settings.show_image_outline,
                  show_rating: section.settings.show_rating,
                  show_product_labels: section.settings.show_product_labels
                %}
              </li>
            {% endfor %}
          </div>
        </ul>
        <div class="cart carousel-button-prev">
          <svg class="icon icon-filter-arrow-up" viewBox="0 0 16 9" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <g id="PLP-&amp;-Search-(Batch-2)" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                <g id="PLP-Filters-Open" transform="translate(-1325.000000, -754.000000)" fill="#444444" fill-rule="nonzero">
                    <path d="M1329.17623,751.169473 C1329.28876,751.060976 1329.44157,751 1329.60092,751 C1329.76027,751 1329.91307,751.060976 1330.02561,751.169473 L1337.22377,758.091738 C1337.33659,758.199961 1337.4,758.346907 1337.4,758.500151 C1337.4,758.653395 1337.33659,758.800342 1337.22377,758.908565 L1330.02561,765.83083 C1329.79106,766.05639 1329.41078,766.05639 1329.17623,765.83083 C1328.94168,765.605269 1328.94168,765.239563 1329.17623,765.014002 L1335.9509,758.500151 L1329.17623,751.9863 C1329.06341,751.878077 1329,751.731131 1329,751.577887 C1329,751.424642 1329.06341,751.277696 1329.17623,751.169473 Z" id="Path-Copy-2" transform="translate(1333.200000, 758.500000) scale(1, -1) rotate(90.000000) translate(-1333.200000, -758.500000) "></path>
                </g>
            </g>
          </svg>
        </div>
        <div class="cart carousel-button-next">
          <svg class="icon icon-filter-arrow-up" viewBox="0 0 16 9" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <g id="PLP-&amp;-Search-(Batch-2)" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                <g id="PLP-Filters-Open" transform="translate(-1325.000000, -754.000000)" fill="#444444" fill-rule="nonzero">
                    <path d="M1329.17623,751.169473 C1329.28876,751.060976 1329.44157,751 1329.60092,751 C1329.76027,751 1329.91307,751.060976 1330.02561,751.169473 L1337.22377,758.091738 C1337.33659,758.199961 1337.4,758.346907 1337.4,758.500151 C1337.4,758.653395 1337.33659,758.800342 1337.22377,758.908565 L1330.02561,765.83083 C1329.79106,766.05639 1329.41078,766.05639 1329.17623,765.83083 C1328.94168,765.605269 1328.94168,765.239563 1329.17623,765.014002 L1335.9509,758.500151 L1329.17623,751.9863 C1329.06341,751.878077 1329,751.731131 1329,751.577887 C1329,751.424642 1329.06341,751.277696 1329.17623,751.169473 Z" id="Path-Copy-2" transform="translate(1333.200000, 758.500000) scale(1, -1) rotate(90.000000) translate(-1333.200000, -758.500000) "></path>
                </g>
            </g>
          </svg>
        </div>
      </div>
    {% endif %}
  </product-recommendations>
</div>

{% javascript %}
  class ProductRecommendations extends HTMLElement {
    constructor() {
      super();

      const handleIntersection = (entries, observer) => {
        if (!entries[0].isIntersecting) return;
        observer.unobserve(this);

        fetch(this.dataset.url)
          .then(response => response.text())
          .then(text => {
            const html = document.createElement('div');
            html.innerHTML = text;
            const recommendations = html.querySelector('product-recommendations');
            if (recommendations && recommendations.innerHTML.trim().length) {
              this.innerHTML = recommendations.innerHTML;

              let swiper = new Swiper(".cart-recommendation_slider .mySwiper", {
                slidesPerView: "auto",
                slidesPerGroup: 1,
                spaceBetween: 10,
                navigation: {
                  nextEl: ".cart.carousel-button-next",
                  prevEl: ".cart.carousel-button-prev",
                },
                breakpoints: {
                  750: {
                    slidesPerView: 3,
                    slidesPerGroup: 3,
                    spaceBetween: 10,
                  },
                  1158: {
                    slidesPerView: 4,
                    slidesPerGroup: 4,
                    spaceBetween: 10,
                  },
                }
              });
            }

          })
          .catch(e => {
            console.error(e);
          });
      }

      new IntersectionObserver(handleIntersection.bind(this), {rootMargin: '0px 0px 200px 0px'}).observe(this);
    }
  }

  customElements.define('product-recommendations', ProductRecommendations);
{% endjavascript %}

{% style %}
  {% if section.settings.text_color != 'rgba(0,0,0,0)' %}
  .cart-recommendations__heading,
  .cart-recommendations .full-unstyled-link,
  .cart-recommendations .card-information__wrapper > .price,
  .cart-recommendations .option_count {
    color: {{ section.settings.text_color }};
  }
  {% endif %}


@media screen and (max-width: 750px) {
 .cart-recommendations {
    padding: {{ section.settings.mobile_top_padding }}px 0 {{ section.settings.mobile_bottom_padding }}px;
  {% if section.settings.background_mobile %}
    background: url({{ section.settings.background_mobile | image_url }});
    background-size:cover;
    background-position: center center;
  {% endif %}
  }
}

@media screen and (min-width: 749px) {
  .cart-recommendations {
    padding: {{ section.settings.desktop_top_padding }}px 0 {{ section.settings.desktop_bottom_padding }}px;
  {% if section.settings.background_desktop %}
    background: url({{ section.settings.background_desktop | image_url }});
    background-size:cover;
    background-position: center center;
  {% endif %}
  }
}
{% endstyle %}

{% schema %}
{
  "name": "Cart recommendations",
  "tag": "section",
  "class": "spaced-section page-width",
  "settings": [
    {
      "type": "paragraph",
      "content": "Dynamic recommendations use order and product information to change and improve over time. [Learn more](https://help.shopify.com/en/themes/development/recommended-products)"
    },
    {
      "type": "header",
      "content": "Section colors"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color"
    },
    {
      "type": "image_picker",
      "id": "background_desktop",
      "label": "Desktop image",
      "info": "An aspect ratio of 16:9 is recommended."
    },
    {
      "type": "image_picker",
      "id": "background_mobile",
      "label": "Mobile image",
      "info": "An aspect ratio of 1:3 is recommended."
    },
    {
      "type": "header",
      "content": "Heading"
    },
    {
      "type": "text",
      "id": "heading",
      "default": "You may also like",
      "label": "Headline"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "cql-headline-1",
          "label": "Custom Headline 1"
        },
        {
          "value": "cql-headline-2",
          "label": "Custom Headline 2"
        },
        {
          "value": "cql-headline-3",
          "label": "Custom Headline 3"
        },
        {
          "value": "h4",
          "label": "X-Small"
        },
        {
          "value": "h3",
          "label": "Small"
        },
        {
          "value": "h2",
          "label": "Medium"
        },
        {
          "value": "h1",
          "label": "Large"
        },
        {
          "value": "h0",
          "label": "X-Large"
        }
      ],
      "default": "h2",
      "label": "Headline size"
    },
    {
      "type": "header",
      "content": "Product card"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "Adapt to image"
        },
        {
          "value": "portrait",
          "label": "Portrait"
        },
        {
          "value": "square",
          "label": "Square"
        }
      ],
      "default": "adapt",
      "label": "Image ratio"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": false,
      "label": "Show second image on hover"
    },
    {
      "type": "checkbox",
      "id": "add_image_padding",
      "default": false,
      "label": "Add image padding"
    },
    {
      "type": "checkbox",
      "id": "show_image_outline",
      "default": true,
      "label": "Show image border"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    },
    {
      "type": "checkbox",
      "id": "show_product_labels",
      "default": true,
      "label": "Show product label"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "number",
      "id": "desktop_top_padding",
      "label": "Desktop top padding (px)",
      "default": 60
    },
    {
      "type": "number",
      "id": "desktop_bottom_padding",
      "label": "Desktop bottom padding (px)",
      "default": 60
    },
    {
      "type": "number",
      "id": "mobile_top_padding",
      "label": "Mobile top padding (px)",
      "default": 45
    },
    {
      "type": "number",
      "id": "mobile_bottom_padding",
      "label": "Mobile bottom padding (px)",
      "default": 45
    },
    {
      "type": "header",
      "content": "Margins",
      "info": "Apply global theme layout margins on the top and bottom"
    },
    {
      "type": "checkbox",
      "id": "display_margins",
      "label": "Display margins",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Cart recommendation"
    }
  ]
}
{% endschema %}
